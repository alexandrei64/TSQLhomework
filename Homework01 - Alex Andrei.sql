/*
HOMEWORK_01_DBDEV_SIIT
CREATED BY ALEX ANDREI
*/

--STEP 1: WE CREATE THE DATABASE OF OUR STOCK EXCHANGE

CREATE DATABASE STOCK_EXCHANGE;
GO

--STEP 2: WE SWITCH TO USE THE DATABASE WE JUST CREATED

USE STOCK_EXCHANGE;
GO

--STEP 3: WE CREATE THREE TABLES

/*
FIRST TABLE CONTAINS THE NAME OF THE COMPANY AND TICKER LINKED TO AN UNIQUE IDENTIFIER
SECOND TABLE CONTAINS USEFUL INFORMATIONS RELATED TO THE COMPANIES THAT WILL BE LISTED ON OUR STOCK EXCHANGE
THIRD TABLE CONTAINS DAILY PRICE DATA FOR EACH COMPANY
*/


CREATE TABLE TRADED_COMPANIES (
	COMPANY_ID INT PRIMARY KEY NOT NULL,
	COMPANY_NAME VARCHAR (128),
	TICKER VARCHAR(128)
	);

CREATE TABLE COMPANY_INFO (
	COMPANY_ID INT,
	COUNTRY VARCHAR(128)
	);

CREATE TABLE PRICES (
	COMPANY_ID INT,
	TRADE_DATE DATE,
	OPEN_PRICE INT,
	CLOSE_PRICE INT,
	VOLUME_TRADED BIGINT,
	);
GO

--STEP 4: WE ADD THE COMPANIES THAT ARE LISTED ON OUR STOCK EXCHANGE IN THE TRADED_COMPANIES TABLE

INSERT INTO TRADED_COMPANIES (COMPANY_ID, COMPANY_NAME, TICKER)
	VALUES
		(1, 'APPLE INC', 'AAPL'),
		(2, 'MICROSOFT CORPORATION', 'MSFT'),
		(3, 'DELL TECHNOLOGIES INC', 'DELL'),
		(4, 'TESLA INC', 'TSLA'),
		(5, 'ALPHABET INC', 'GOOG'),
		(6, 'DOW JONES INDUSTRIAL AVERAGE', 'DJI');
GO

--STEP 5: WE ADD INFORMATIONS ABOUT THE COMPANIES IN THE COMPANY_INFO TABLE

	--STEP 5.1: WE TAKE A LOOK AT THE COMPANY_INFO TABLE

	SELECT * FROM COMPANY_INFO

	/*
	WE REALISE THAT WE NEED MORE COLUMNS TO DISPLAY MORE TYPES OF DATA, LIKE THE CITY IN WHICH THE COMPANY RESIDES,
	THE INDUSTRY IN WHICH IT ACTIVATES AND THE NUMBER OF EMPLOYEES.
	*/

	--STEP 5.2: WE WRITE A QUERY TO CORRECT THE ISSUE FOUND IN TABLE COMPANY_INFO

	ALTER TABLE COMPANY_INFO ADD CITY VARCHAR(128), INDUSTRY VARCHAR(128), NO_EMPLOYEES INT;
	GO

	--STEP 5.3: WE FINISH ADDING INFO ABOUT THE LISTED COMPANIES TO OUR TABLE

	INSERT INTO COMPANY_INFO
	VALUES
		(2, 'USA', 'REDMOND', 'TECHNOLOGY', 144000),
		(5, 'USA', 'MOUNTAIN VIEW', 'TECHNOLOGY', 114096),
		(1, 'USA', 'CUPERTINO', 'TECHNOLOGY', 137000),
		(4, 'USA', 'PALO ALTO', 'AUTOMOTIVE', 48817),
		(3, 'USA', 'ROUND ROCK', 'TECHNOLOGY', 157000);
	GO

--STEP 6: WE WORK WITH THE PRICES TABLE

--STEP 6.1: WE ADD PRICE DATA FOR THE LAST WEEK OF TRADING THAT WE GATHERED FROM OUR STOCK EXCHANGE ACTIVITY

INSERT INTO PRICES
	VALUES
		(1, '2019-11-01', 250, 256, 37738700),
		(1, '2019-10-31', 249, 248, 3476660000),
		(1, '2019-10-30', 245, 243, 30950600),
		(1, '2019-10-29', 249, 243, 35660100),
		(1, '2019-10-28', 249, 249, 24143200),
		(2, '2019-11-01', 144, 143, 33119200),
		(2, '2019-10-31', 144, 143, 2459620000),
		(2, '2019-10-30', 143, 144, 18471700),
		(2, '2019-10-29', 144, 142, 20519700),
		(2, '2019-10-28', 144, 144, 35280100),
		(3, '2019-11-01', 53, 53, 1215900),
		(3, '2019-10-31', 53, 52, 153710000),
		(3, '2019-10-30', 54, 53, 1627400),
		(3, '2019-10-29', 53, 53, 2648800),
		(3, '2019-10-28', 52, 51, 1579900),
		(4, '2019-11-01', 316, 313, 6380900),
		(4, '2019-10-31', 313, 314, 505990000),
		(4, '2019-10-30', 313, 315, 9637000),
		(4, '2019-10-29', 319, 316, 12673300),
		(4, '2019-10-28', 327, 327, 18870300),
		(5, '2019-11-01', 1265, 1273, 1669400),
		(5, '2019-10-31', 1261, 1260, 145470000),
		(5, '2019-10-30', 1252, 1261, 1407700),
		(5, '2019-10-29', 1276, 1262, 1869200),
		(5, '2019-10-28', 1275, 1290, 2613200);
GO

--STEP 6.2: WE ADD A COLUMN TO THE PRICES TABLE THAT INDICATES THE WEEK NUMBER IN THE YEAR FOR EACH TABLE LINE

ALTER TABLE PRICES ADD TRADE_WEEK INT;
GO
UPDATE PRICES SET TRADE_WEEK = 44;
GO

--STEP 7: WE CREATE A QUERY THAT RETURNS ALL COMPANY INFO FOR EACH TICKER


SELECT DISTINCT TICKER, COMPANY_NAME, COUNTRY, CITY, INDUSTRY, NO_EMPLOYEES FROM TRADED_COMPANIES
INNER JOIN COMPANY_INFO
ON TRADED_COMPANIES.COMPANY_ID = COMPANY_INFO.COMPANY_ID;
GO

--STEP 8: WE CREATE A QUEARY THAT RETURNS TRADE DATES, VOLUME, OPEN AND CLOSE PRICES FOR TICKER 'TSLA'

SELECT TICKER, TRADE_DATE, OPEN_PRICE, CLOSE_PRICE, VOLUME_TRADED FROM PRICES
INNER JOIN TRADED_COMPANIES
ON TRADED_COMPANIES.COMPANY_ID = PRICES.COMPANY_ID
WHERE TICKER = 'TSLA';
GO

--STEP 9: WE NOTICE AN EXTRA LINE IDENTIFIED WITH COMPANY_ID 6 IN THE TRADED_COMPANIES TABLE AND WE WANT TO DELETE IT AS IT'S NOT A TRADED COMPANY

DELETE FROM TRADED_COMPANIES WHERE COMPANY_ID = 6;
GO
SELECT * FROM TRADED_COMPANIES;
GO

--STEP 10: WE CREATE A QUERY THAT RETURNS US THE AVERAGE TRADE VOLUME FROM THE TABLE PRICES WITH A NEW, MORE SUGGESTIVE, COLUMN NAME

SELECT AVG(VOLUME_TRADED) AS 'AVG_TRADE_VOL' FROM PRICES;
GO

--END
